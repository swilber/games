<!DOCTYPE html>
<html>
<head>
    <title>Mario Entity System Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }
        #game-area {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div id="game-area">
        <h1 style="text-align: center;">Mario Entity System Demo</h1>
        <p style="text-align: center;">Loading...</p>
    </div>

    <script type="module">
        // Entity System Classes (inline for demo)
        class Entity {
            constructor(id = null) {
                this.id = id || Math.random().toString(36).substr(2, 9);
                this.components = new Map();
                this.active = true;
            }
            
            add(name, component) {
                this.components.set(name, component);
                return this;
            }
            
            get(name) {
                return this.components.get(name);
            }
            
            has(name) {
                return this.components.has(name);
            }
        }

        class Transform {
            constructor(x = 0, y = 0, width = 16, height = 16) {
                this.x = x; this.y = y; this.width = width; this.height = height;
            }
        }

        class Physics {
            constructor(vx = 0, vy = 0) {
                this.vx = vx; this.vy = vy; this.gravity = 0.5; this.onGround = false;
            }
        }

        class Sprite {
            constructor(color = '#FF0000') {
                this.color = color;
            }
        }

        class AI {
            constructor(type = 'patrol') {
                this.type = type; this.direction = -1;
            }
        }

        class EntityManager {
            constructor() {
                this.entities = new Map();
                this.systems = [];
            }
            
            create(id = null) {
                const entity = new Entity(id);
                this.entities.set(entity.id, entity);
                return entity;
            }
            
            query(...componentNames) {
                return Array.from(this.entities.values()).filter(entity =>
                    componentNames.every(name => entity.has(name))
                );
            }
            
            addSystem(system) {
                this.systems.push(system);
            }
            
            update() {
                this.systems.forEach(system => system.update(this));
            }
        }

        class PhysicsSystem {
            update(entityManager) {
                const entities = entityManager.query('transform', 'physics');
                entities.forEach(entity => {
                    const transform = entity.get('transform');
                    const physics = entity.get('physics');
                    
                    // Apply gravity
                    physics.vy += 0.5;
                    
                    // Apply velocity
                    transform.x += physics.vx;
                    transform.y += physics.vy;
                    
                    // Ground collision (platform at y=350)
                    if (transform.y + transform.height > 350) {
                        transform.y = 350 - transform.height;
                        physics.vy = 0;
                        physics.onGround = true;
                    } else {
                        physics.onGround = false;
                    }
                    
                    // Terminal velocity
                    if (physics.vy > 15) physics.vy = 15;
                });
            }
        }

        class AISystem {
            update(entityManager) {
                const entities = entityManager.query('transform', 'physics', 'ai');
                entities.forEach(entity => {
                    const transform = entity.get('transform');
                    const physics = entity.get('physics');
                    const ai = entity.get('ai');
                    
                    // Check boundaries and reverse direction if needed
                    if (transform.x <= 0 && ai.direction < 0) {
                        ai.direction = 1;
                    } else if (transform.x >= 800 - transform.width && ai.direction > 0) {
                        ai.direction = -1;
                    }
                    
                    physics.vx = ai.direction;
                });
            }
        }

        class CollisionSystem {
            update(entityManager) {
                const player = entityManager.entities.get('player');
                if (!player) return;
                
                const playerTransform = player.get('transform');
                const playerPhysics = player.get('physics');
                
                const enemies = entityManager.query('transform', 'ai');
                enemies.forEach(enemy => {
                    const enemyTransform = enemy.get('transform');
                    
                    if (this.isColliding(playerTransform, enemyTransform)) {
                        // Check if player is stomping (falling and above enemy)
                        if (playerPhysics.vy > 0 && playerTransform.y < enemyTransform.y - 8) {
                            // Stomp enemy
                            enemyTransform.height = 8;
                            enemy.components.delete('ai');
                            enemy.components.delete('physics');
                            playerPhysics.vy = -8; // Bounce
                        } else {
                            // Side collision - damage player
                            playerTransform.x = 50;
                            playerTransform.y = 300;
                            playerPhysics.vx = 0;
                            playerPhysics.vy = 0;
                        }
                    }
                });
            }
            
            isColliding(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            }
        }

        class Camera {
            constructor(x = 0, y = 0) {
                this.x = x;
                this.y = y;
            }
            
            move(dx, dy) {
                this.x += dx;
                this.y += dy;
            }
        }

        class RenderSystem {
            constructor() {
                this.lastLogTime = 0;
                console.log('RenderSystem created');
            }
            
            render(ctx, entityManager, camera) {
                const entities = entityManager.query('transform', 'sprite');
                
                // Log positions once per second
                const now = Date.now();
                if (now - this.lastLogTime >= 1000) {
                    console.log(`--- Position Update (${now - this.lastLogTime}ms since last) ---`);
                    entities.forEach(entity => {
                        const transform = entity.get('transform');
                        const cameraX = transform.x - camera.x;
                        const cameraY = transform.y - camera.y;
                        console.log(`Entity ${entity.id}: global(${transform.x}, ${transform.y}) camera(${cameraX}, ${cameraY})`);
                    });
                    this.lastLogTime = now;
                }
                
                entities.forEach(entity => {
                    const transform = entity.get('transform');
                    const sprite = entity.get('sprite');
                    
                    // Render at camera-relative position
                    const screenX = transform.x - camera.x;
                    const screenY = transform.y - camera.y;
                    
                    ctx.fillStyle = sprite.color;
                    ctx.fillRect(screenX, screenY, transform.width, transform.height);
                });
            }
        }

        // Demo
        function startDemo() {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 400;
            canvas.style.border = '2px solid #000';
            
            const ctx = canvas.getContext('2d');
            const entityManager = new EntityManager();
            
            entityManager.addSystem(new PhysicsSystem());
            entityManager.addSystem(new AISystem());
            entityManager.addSystem(new CollisionSystem());
            const renderSystem = new RenderSystem();
            const camera = new Camera(0, 0);
            
            // Create entities
            const player = entityManager.create('player')
                .add('transform', new Transform(50, 300, 16, 16))
                .add('physics', new Physics(0, 0))
                .add('sprite', new Sprite('#FF0000'));
                
            const goomba1 = entityManager.create('goomba1')
                .add('transform', new Transform(200, 334, 16, 16))
                .add('physics', new Physics(-1, 0))
                .add('sprite', new Sprite('#8B4513'))
                .add('ai', new AI('patrol'));
                
            const goomba2 = entityManager.create('goomba2')
                .add('transform', new Transform(900, 334, 16, 16))
                .add('physics', new Physics(-1, 0))
                .add('sprite', new Sprite('#8B4513'))
                .add('ai', new AI('patrol'));
                
            const goomba3 = entityManager.create('goomba3')
                .add('transform', new Transform(1200, 334, 16, 16))
                .add('physics', new Physics(-1, 0))
                .add('sprite', new Sprite('#8B4513'))
                .add('ai', new AI('patrol'));
                
            const goomba4 = entityManager.create('goomba4')
                .add('transform', new Transform(600, 334, 16, 16))
                .add('physics', new Physics(-1, 0))
                .add('sprite', new Sprite('#8B4513'))
                .add('ai', new AI('patrol'));
                
            const goomba5 = entityManager.create('goomba5')
                .add('transform', new Transform(800, 334, 16, 16))
                .add('physics', new Physics(-1, 0))
                .add('sprite', new Sprite('#8B4513'))
                .add('ai', new AI('patrol'));
                
            const goomba6 = entityManager.create('goomba6')
                .add('transform', new Transform(1400, 334, 16, 16))
                .add('physics', new Physics(-1, 0))
                .add('sprite', new Sprite('#8B4513'))
                .add('ai', new AI('patrol'));
                
            const goomba7 = entityManager.create('goomba7')
                .add('transform', new Transform(1600, 334, 16, 16))
                .add('physics', new Physics(-1, 0))
                .add('sprite', new Sprite('#8B4513'))
                .add('ai', new AI('patrol'));
                
            const koopa1 = entityManager.create('koopa1')
                .add('transform', new Transform(400, 334, 16, 24))
                .add('physics', new Physics(-0.5, 0))
                .add('sprite', new Sprite('#00AA00'))
                .add('ai', new AI('patrol'));
                
            const koopa2 = entityManager.create('koopa2')
                .add('transform', new Transform(1500, 334, 16, 24))
                .add('physics', new Physics(-0.5, 0))
                .add('sprite', new Sprite('#00AA00'))
                .add('ai', new AI('patrol'));
                
            const coin1 = entityManager.create('coin1')
                .add('transform', new Transform(300, 280, 12, 12))
                .add('sprite', new Sprite('#FFD700'));
                
            const coin2 = entityManager.create('coin2')
                .add('transform', new Transform(1100, 280, 12, 12))
                .add('sprite', new Sprite('#FFD700'));
                
            const coin3 = entityManager.create('coin3')
                .add('transform', new Transform(1800, 280, 12, 12))
                .add('sprite', new Sprite('#FFD700'));
                
            const platform = entityManager.create('platform')
                .add('transform', new Transform(0, 350, 2000, 50))
                .add('sprite', new Sprite('#00AA00'));
            
            // Input
            const keys = {};
            document.addEventListener('keydown', (e) => keys[e.code] = true);
            document.addEventListener('keyup', (e) => keys[e.code] = false);
            
            function gameLoop() {
                const playerTransform = player.get('transform');
                const playerPhysics = player.get('physics');
                
                if (keys['ArrowLeft'] || keys['KeyA']) {
                    playerPhysics.vx = -3;
                } else if (keys['ArrowRight'] || keys['KeyD']) {
                    playerPhysics.vx = 3;
                } else {
                    playerPhysics.vx *= 0.8;
                }
                
                if ((keys['ArrowUp'] || keys['Space']) && playerPhysics.onGround) {
                    playerPhysics.vy = -12;
                }
                
                // Camera controls
                if (keys['KeyA'] || keys['ArrowLeft']) {
                    camera.move(-3, 0);
                }
                if (keys['KeyD'] || keys['ArrowRight']) {
                    camera.move(3, 0);
                }
                
                entityManager.update();
                
                ctx.fillStyle = '#5C94FC';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                renderSystem.render(ctx, entityManager, camera);
                
                ctx.fillStyle = '#000';
                ctx.font = '16px Arial';
                ctx.fillText(`Entities: ${entityManager.entities.size}`, 10, 30);
                
                requestAnimationFrame(gameLoop);
            }
            
            const gameArea = document.getElementById('game-area');
            gameArea.innerHTML = '';
            
            const title = document.createElement('h2');
            title.textContent = 'Entity System Demo';
            title.style.textAlign = 'center';
            
            const instructions = document.createElement('p');
            instructions.textContent = 'Arrow keys or WASD to move, Space to jump';
            instructions.style.textAlign = 'center';
            
            gameArea.appendChild(title);
            gameArea.appendChild(instructions);
            gameArea.appendChild(canvas);
            
            gameLoop();
        }
        
        startDemo();
    </script>
</body>
</html>
