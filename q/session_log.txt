# Q Session Log
Last Updated: 2025-12-06T00:38:46.242-07:00

## PURPOSE
Track recent commands and context to recover from context window overflows.

## CURRENT SESSION SUMMARY
- **Working on**: Complete Excitebike-style dirt bike racing game with authentic mechanics
- **Latest changes**: 
  - **FIXED**: Oil slick collision detection during lane transitions to prevent cross-lane effects
  - **IMPLEMENTED**: Transition-aware lane detection using 50% threshold for accurate collision
  - **ELIMINATED**: False oil slick slowdowns when player is in adjacent lanes
  - **ENHANCED**: Precise collision detection based on visual player position during transitions
  - **COMMITTED**: Complete oil slick collision fix (commit 519e5a4)
  - **Previous**: Game completion logic to only advance winners to question screen
  - **Previous**: Final position storage to prevent placement changes after finish
  - **Previous**: Rotation control fixes and configurable opponent crash frequency

## LAP SYSTEM IMPLEMENTATION DETAILS
- **Track Structure**: `totalTrackLength = trackLength * lapsRequired` (6000 pixels for 3 laps)
- **Lap Calculation**: `Math.floor(player.position / trackLength) + 1` for current lap
- **Lap Markers**: Yellow vertical lines at positions `lap * trackLength + 400`
- **Finish Line**: Black checkered pattern only appears at `totalTrackLength + 400`
- **Race Completion**: Changed from `player.position >= trackLength` to `player.position >= totalTrackLength`
- **UI Display**: Shows "Lap: X/3" with proper clamping to prevent showing "Lap: 4/3"

## KEY DEVELOPMENT INSIGHTS
- **Pre-rendered optimization**: Track elements drawn once to off-screen canvas for performance
- **Animation sequences**: Multi-phase animations (falling → walking → recovery) create engaging gameplay
- **State management**: Crash states require careful coordination between rendering and game logic
- **Visual storytelling**: Different rendering modes (normal, crashed, walking) communicate game state clearly
- **Collision systems**: Separate detection for rider collisions vs landing angle crashes
- **Recovery mechanics**: Timed recovery sequences add consequence to crashes without being punitive
- **Lap progression**: Visual markers and UI feedback essential for player understanding of race progress

## KEY LEARNINGS
- **Game Balance Critical**: Initial heat system was unplayable (overheated immediately)
- **Visual Authenticity Matters**: Simple triangular ramps looked flat, needed proper 3D perspective
- **Iterative Refinement**: Started with basic concept, evolved through feedback to full recreation
- **Physics Tuning**: Heat rates, cooling rates, and penalties need careful balancing for fun gameplay
  - **REVERTED**: Previous change that made ghosts exactly same speed as Pac-Man
  - **FORMULA**: Ghost delay = `(config.ghosts.speed) / (player.speed * ghostSpeedMultiplier)`
  - **PERSONALITIES**: Vulnerable ghosts move at 0.5x speed, normal ghosts at 1.0x speed
  - **SCALING**: When player speed changes, ghost speeds automatically scale proportionally
  - **UPDATED**: Ghost speed to match Pac-Man speed for balanced gameplay
  - **CHANGED**: Ghost movement from fixed delay system to same speed increment as Pac-Man
- **Previous changes**: 
  - **REFACTORED**: Question system to use ordered arrays instead of ID-based matching
  - **ADDED**: 14 difficult Bible trivia questions requiring research and lookup
  - **IMPLEMENTED**: Question encryption system to prevent casual browsing
  - **CREATED**: Encryption/decryption utilities for development workflow
  - **ENHANCED**: Final math question using clever sorted position calculations
- **Key improvements**:
  - Pac-Man speed now properly responds to configuration changes via game settings UI
  - Both fallback config and runtime config use consistent `player.speed` property
  - Questions use ordered arrays - game N uses answer[N-1] to unlock, shows question[N] when completed
  - All 14 questions have unique numeric answers spanning Old and New Testament
  - Questions encrypted in questions.enc file, decrypted at runtime
- **Status**: Pac-Man speed configuration fixes pushed to git (commit ebfccaf)

## ENCRYPTION WORKFLOW
**To update questions:**
1. Run `node encrypt-questions.js` to create questions.json from encrypted file
2. Edit questions.json with new content
3. Run `node encrypt-questions.js` again to update questions.enc
4. Delete questions.json (it's in .gitignore)
5. Commit and push questions.enc

**Files:**
- `questions.enc` - Encrypted questions file (committed to git)
- `questions.json` - Temporary decrypted file for editing (gitignored)
- `encrypt-questions.js` - Utility script for encryption/decryption (gitignored)
- `.gitignore` - Prevents accidental commit of decrypted files

## RECENT CHANGES SUMMARY
1. **Pac-Man Wall Rendering with Rounded Corners**: Implemented both convex and concave rounded corners using unified logic. Convex corners handled from wall cell perspective with shortened lines and outward arcs. Concave corners handled from empty cell perspective with inward arcs. Used same positioning and arc angles for consistency. Separated line drawing and arc drawing for cleaner implementation.

2. **ASCII Map Loading System**: Added support for loading Pac-Man maps from ASCII text files. Implemented `loadAsciiMap()` function that parses "#" (walls), "*" (dots), "@" (power pellets), "G" (ghost starts), "C" (Pac-Man start). Game now loads `./games/pacman/maps/level1.txt` and positions characters based on map data.

2. **Pac-Man Levels to Win Configuration**: Added `levelsToWin` setting to gameplay section in Pac-Man config. Moved from difficulty section to gameplay so it appears in configuration UI. Updated game initialization to use `pacmanConfig.gameplay.levelsToWin` instead of `settings.levelsToWin`.

2. **Configuration Modal Scrolling Fix**: Fixed mouse wheel scrolling in game configuration menu by updating CSS height constraints. Changed modal max-height from 80% to 80vh and added min-height: 0 and max-height calc() to #config-content to ensure proper scrollable area dimensions.

2. **Ghost Speed Scaling Implementation**: Updated ghosts to scale with player speed while maintaining personalities. Used formula `scaledDelay = (ghosts.speed) / (player.speed * ghostSpeedMultiplier)` where vulnerable ghosts use 0.5x multiplier, normal ghosts use 1.0x multiplier.

2. **Pac-Man Speed Configuration Fix**: Fixed player speed configuration not affecting gameplay by changing `pacmanConfig.player.moveSpeed` to `pacmanConfig.player.speed` to match JSON config property names.

3. **Configuration Property Consistency**: Updated both game code and fallback config to use consistent property names between JSON files and JavaScript code.

4. **Question System Encryption**: Implemented encrypted Bible trivia questions using ordered arrays where game N requires answer[N-1] to unlock. Questions stored in questions.enc with development workflow using encrypt-questions.js utility.

5. **GitHub Pages Deployment Fixes**: Resolved asset loading issues by using `./games/` prefix for paths and setting explicit canvas dimensions to prevent coordinate system conflicts.

## TESTING INSTRUCTIONS FOR PAC-MAN SPEED FIX
**Prerequisites:**
1. Game should load normally with current configuration
2. Configuration UI should be accessible via debug mode (add `?gubed` to URL)

**Test Steps:**
1. **Access Configuration:**
   - Add `?gubed` to URL to enable debug mode
   - Click ⚙️ Configuration button
   - Switch to "Game" tab
   - Select "Pac-Man" from dropdown

2. **Test Speed Configuration:**
   - Note current player speed value (should be 0.66)
   - Change player speed to a different value (e.g., 0.2 for slower, 1.0 for faster)
   - Click "Save Changes"
   - Close configuration modal

3. **Verify Speed Change:**
   - Start Pac-Man game from level selection
   - Use arrow keys to move Pac-Man
   - Verify movement speed matches the configured value
   - Lower values = slower movement, higher values = faster movement

4. **Test Multiple Values:**
   - Try speed values: 0.1 (very slow), 0.5 (medium), 1.5 (fast)
   - Each change should be immediately noticeable in gameplay
   - Movement should be smooth and responsive at all speeds

5. **Reset Test:**
   - Open configuration again
   - Click "Reset to Defaults" 
   - Verify speed returns to default value (0.66)
   - Test that default speed works correctly

**Expected Results:**
- Configuration changes should immediately affect Pac-Man movement speed
- No console errors when changing speed values
- Game should remain playable at all reasonable speed values
- Speed changes should persist until reset or changed again

**Issue Resolution:**
- **Problem**: Game was looking for `player.moveSpeed` but config had `player.speed`
- **Solution**: Updated game code to use correct config property name
- **Files Changed**: `./games/pacman/src/pacman.js` (lines 18 and 207)

## NEW LEARNINGS - GITHUB PAGES DEPLOYMENT
- **Path Resolution**: GitHub Pages requires `./games/` prefix for asset paths
- **Canvas Scaling**: Must set both canvas properties AND CSS styles to prevent coordinate system issues
- **Asset Loading**: Working pattern is `./games/[gamename]/[asset]?v=${Date.now()}`
- **Testing Required**: Always test both local development AND GitHub Pages deployment
- **Cross-Reference**: Compare working games (Mario) with broken games (Donkey Kong) to identify patterns

## TESTING INSTRUCTIONS FOR QUESTION SYSTEM
**Prerequisites:**
1. Game should load normally with encrypted questions
2. Questions should decrypt seamlessly at runtime

**Test Steps:**
1. **Basic Functionality:**
   - Complete Level 1 - should show first question
   - Try to access Level 2 - should require answer from Level 1's question
   - Verify all 15 levels work with proper question/answer flow

2. **Question Content:**
   - All questions should be difficult Bible trivia requiring research
   - Each question should have unique numeric answer
   - Final question should use mathematical calculation with sorted positions

3. **Encryption Security:**
   - Browse git repository - should only see questions.enc (encrypted)
   - questions.json should not be in git history
   - Game should load questions normally despite encryption

4. **Development Workflow:**
   - Run `node encrypt-questions.js` to create questions.json
   - Edit questions.json
   - Run script again to update questions.enc
   - Verify changes appear in game

## IMPORTANT WORKFLOW CHANGE
- **DO NOT automatically push to git** - wait for explicit user instructions
- **ALWAYS provide comprehensive testing instructions** for new features
- **UPDATE q/* files** when discovering new patterns or system requirements
- **FOLLOW all instructions** in q/startup.txt and related files
- **USE encryption workflow** when updating questions

## ACTIVE CONTEXT
- **Working directory**: /Users/P2176038/Desktop/greg
- **Current branch**: main
- **Project**: Arcade games collection with encrypted Bible trivia question system
- **Focus**: Difficult Bible trivia with encryption for security
- **Next**: Ready for testing encrypted question system or additional enhancements

## RECOVERY INSTRUCTIONS
If context overflows, user has implemented comprehensive question system refactor with encryption. Questions use ordered arrays where game N requires answer[N-1] to unlock and shows question[N] when completed. All questions are difficult Bible trivia with unique numeric answers, encrypted in questions.enc file. Use encrypt-questions.js utility to update questions. System includes bypass feature for development and proper game/question flow management.
